<div class="place-show-page">
  <!-- Hero Header -->
  <section class="place-header-show">
    <div class="place-header-content">
      <nav class="place-breadcrumb">
        <%= link_to "Home", root_path, class: "breadcrumb-link" %>
        <span class="breadcrumb-separator">></span>
        <%= link_to @place.city.name, city_places_path(@place.city), class: "breadcrumb-link" %>
        <span class="breadcrumb-separator">></span>
        <span><%= @place.title %></span>
      </nav>
      <div class="side-btn">
        <h1 class="place-title"><%= @place.title %></h1>
          <%= turbo_frame_tag "place_heart_#{@place.id}" do %>
            <% if user_signed_in? %>
              <% travel_book = current_user.travel_book %>
              <% if travel_book && travel_book.places.include?(@place) %>
                <% travel_book_place = travel_book.travel_book_places.find_by(place: @place) %>
                <%= button_to travel_book_place_path(travel_book_place), method: :delete, class: "place-heart-btn saved", title: "Remove from Travel Book", data: { turbo_frame: "place_heart_#{@place.id}" } do %>
                  <i class="fa-solid fa-heart"></i>
                <% end %>
              <% else %>
                <%= button_to place_travel_book_places_path(@place), method: :post, class: "place-heart-btn", title: "Add to Travel Book", data: { turbo_frame: "place_heart_#{@place.id}" } do %>
                  <i class="fa-regular fa-heart"></i>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
      </div>
      <p class="place-location">
        <i class="fa-solid fa-location-dot"></i> <%= @place.city.name %>
      </p>

      <% if user_signed_in? && current_user.admin? %>
        <div class="place-header-actions">
          <%= button_to city_place_path(@place.city, @place), method: :delete, class: "admin-delete-btn", data: { turbo_confirm: "Are you sure you want to delete this place?" } do %>
            <i class="fa-solid fa-trash"></i> Delete
          <% end %>
        </div>
      <% end %>
    </div>
  </section>

  <div class="container">
    <!-- Carousel + Map Row -->
    <section class="place-media-section">
      <div class="place-media-row">
        <!-- Photo Carousel -->
        <div class="place-carousel-container">
          <% if @all_photos.any? %>
            <div id="placeCarousel" class="carousel slide" data-bs-ride="carousel">
              <!-- Indicators -->
              <div class="carousel-indicators">
                <% @all_photos.each_with_index do |photo, index| %>
                  <button type="button" data-bs-target="#placeCarousel" data-bs-slide-to="<%= index %>"
                    class="<%= 'active' if index == 0 %>" aria-current="<%= 'true' if index == 0 %>"
                    aria-label="Slide <%= index + 1 %>"></button>
                <% end %>
              </div>

              <!-- Slides -->
              <div class="carousel-inner">
                <% @all_photos.each_with_index do |photo, index| %>
                  <div class="carousel-item <%= 'active' if index == 0 %>">
                    <%= cl_image_tag photo.key, height: 500, width: 800, crop: :fill, class: "d-block w-100 carousel-image" %>
                  </div>
                <% end %>
              </div>

              <!-- Controls -->
              <% if @all_photos.size > 1 %>
                <button class="carousel-control-prev" type="button" data-bs-target="#placeCarousel" data-bs-slide="prev">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#placeCarousel" data-bs-slide="next">
                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Next</span>
                </button>
              <% end %>
            </div>
          <% else %>
            <div class="no-photos-placeholder">
              <i class="fa-solid fa-camera fa-3x"></i>
              <p>No photos yet. Be the first to add one!</p>
            </div>
          <% end %>
        </div>

        <!-- Map -->
        <div class="place-map-container">
          <div data-controller="map"
               id="map"
               class="place-map"
               data-map-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>"
               data-map-markers-value="<%= @markers.to_json %>"
               data-map-pop-value="false">
          </div>
        </div>
      </div>
    </section>

    <!-- Description -->
    <section class="place-description-section">
      <%= turbo_stream_from "place_#{@place.id}" %>
      <h2 class="section-heading">About this place</h2>
      <% if flash[:description_loading] || @place.enhanced_description.blank? %>
        <%= render "places/description_loading", place: @place %>
      <% else %>
        <%= render "places/description", place: @place %>
      <% end %>

      <div class="d-flex flex-column justify-content-between align-items-start gap-3 mt-3">
        <div>
          <%= button_to regenerate_description_city_place_path(@place.city, @place), method: :post, class: "ai-badge", title: "Regenerate AI description" do %>
            <i class="fa-solid fa-arrows-rotate"></i></i> Regenerate Text
          <% end %>
        </div>
        <div class="flex-shrink-1 ai-instruction-text">This AI-generated summary is based on the top three highest-voted comments and external, reliable sources to give you the most accurate and unbiased insight. Click the button to refresh it with the newest comments.</div>
      </div>

      <% contributors = @place.comments.includes(:user).map(&:user).uniq %>
      <% if contributors.any? %>
        <div class="contributors-section">
          <div class="contributors-avatars">
            <% contributors.each do |user| %>
              <%= link_to user_path(user), class: "contributor-avatar-link", title: user.username do %>
                <div class="contributor-avatar">
                  <% if user.avatar.attached? && user.avatar.blob&.persisted? %>
                    <%= image_tag url_for(user.avatar), alt: user.username, class: "contributor-avatar-img" %>
                  <% else %>
                    <div class="contributor-avatar-placeholder">
                      <%= user.username&.first&.upcase %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            <% end %>
            <span class="contributors-count"><%= contributors.count %> <%= "contributor".pluralize(contributors.count) %></span>
          </div>
        </div>
      <% end %>
    </section>

    <!-- Comments Section -->
    <section class="place-comments-section" data-controller="collapsible" data-collapsible-expanded-value="true">
      <h2 class="section-heading section-heading-collapsible" data-action="click->collapsible#toggle">
        <i class="fa-solid fa-comments"></i>
        Reviews & Comments
        <span class="comment-count">(<%= @comments&.count || 0 %>)</span>
        <i class="fa-solid fa-chevron-down collapse-icon" data-collapsible-target="icon"></i>
      </h2>

      <% if @comments.any? %>
        <div class="comments-list" data-collapsible-target="content">
          <% @comments.each do |comment| %>
            <div class="comment-card" id="comment_<%= comment.id %>">
              <div class="comment-header">
                <% if user_signed_in? %>
                  <%= render partial: "votes/buttons", locals: { comment: comment } %>
                <% else %>
                  <div class="vote-buttons">
                    <span class="vote-count"><%= comment.vote_balance %></span>
                  </div>
                <% end %>
                <%= link_to user_path(comment.user), class: "comment-avatar-link" do %>
                  <div class="comment-avatar">
                    <% if comment.user.avatar.attached? && comment.user.avatar.blob&.persisted? %>
                      <%= image_tag url_for(comment.user.avatar), alt: comment.user.username, class: "comment-avatar-img" %>
                    <% else %>
                      <span class="comment-avatar-placeholder"><%= comment.user.username&.first&.upcase %></span>
                    <% end %>
                  </div>
                <% end %>
                <div class="comment-meta">
                  <div class="comment-author-row">
                    <%= link_to comment.user.username, user_path(comment.user), class: "comment-author" %>
                    <% if comment.user_is_local? %>
                      <span class="local-badge"><i class="fa-solid fa-location-dot"></i> Local</span>
                    <% end %>
                  </div>
                  <span class="comment-date"><%= time_ago_in_words(comment.created_at) %> ago</span>
                </div>
              </div>
              <div class="comment-body">
                <p><%= comment.description %></p>
              </div>
              <% if comment.photos.attached? %>
                <div class="comment-photos">
                  <% comment.photos.each do |photo| %>
                    <%= cl_image_tag photo.key, height: 80, width: 80, crop: :fill, class: "comment-thumbnail" %>
                  <% end %>
                </div>
              <% end %>

              <%# Reply and Delete buttons %>
              <% if user_signed_in? %>
                <div class="comment-actions">
                  <button class="comment-reply-btn"
                          data-controller="reply-toggle"
                          data-action="click->reply-toggle#showForm"
                          data-reply-toggle-comment-id-value="<%= comment.id %>"
                          data-reply-toggle-mention-value="">
                    <i class="fa-solid fa-reply"></i> Reply
                  </button>
                  <% if comment.user == current_user %>
                    <%= button_to comment_path(comment), method: :delete, class: "comment-delete-btn", data: { turbo_confirm: "Are you sure you want to delete this comment?" } do %>
                      <i class="fa-solid fa-trash"></i> Delete
                    <% end %>
                  <% end %>
                </div>
              <% end %>

              <%# Replies toggle and list %>
              <%= render partial: "replies/toggle", locals: { comment: comment } %>
              <%= render partial: "replies/replies_list", locals: { comment: comment } %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="no-comments" data-collapsible-target="content">
          <i class="fa-regular fa-comment-dots fa-2x"></i>
          <p>No comments yet. Share your experience!</p>
        </div>
      <% end %>
    </section>

    <!-- Add Comment Form -->
    <section class="place-add-comment-section">
      <h2 class="section-heading">
        <i class="fa-solid fa-pen"></i>
        Share Your Experience
      </h2>
      <div class="comment-form-card">
        <%= simple_form_for @comment, url: city_place_comments_path(@place.city, @place), html: { class: "comment-form" } do |f| %>
          <%= f.input :description,
              as: :text,
              label: "Your Review",
              input_html: { rows: 4, placeholder: "Tell others about your experience at this place..." } %>
          <p class="form-hint">
            <i class="fa-solid fa-camera"></i>
            Want to add photos? <%= link_to "Use the camera", camera_path(place_id: @place.id), class: "camera-link" %> to capture and upload.
          </p>
          <div class="form-actions">
            <%= f.submit "Post Comment", class: "btn-submit-comment" %>
          </div>
        <% end %>
      </div>
    </section>
  </div>
</div>

<div class="profile-page">
  <!-- Profile Header -->

  <div class="profile-header">
    <div class="profile-header-bg"></div>
    <div class="profile-header-content">
      <div class="profile-avatar">
        <% if @user.avatar.attached? %>
          <%= cl_image_tag @user.avatar.key, width: 100, height: 100, crop: :fill, class: "avatar-image" %>
        <% else %>
          <div class="avatar-circle">
            <%= @user.username&.first&.upcase || @user.email.first.upcase %>
          </div>
        <% end %>
      </div>
      <h1 class="profile-username-actions"><%= @user.username || "Traveler" %>
        <% if @user == current_user %>

          <%= link_to edit_user_registration_path, class: "profile-edit-btn" do %>
            <i class="fa-solid fa-pen"></i>
          <% end %>
      <% end %> </h1>
      <% if @user.city.present? %>
        <p class="profile-location">
          <i class="fa-solid fa-location-dot"></i>
          <%= @user.city %>
        </p>
      <% end %>


      <p class="profile-member-since">
        <i class="fa-regular fa-calendar"></i>
        Member since <%= @user.created_at.strftime("%B %Y") %>
      </p>

      <% if @user == current_user %>
        <div class="profile-logout d-block d-md-none">
          <%= button_to destroy_user_session_path, method: :delete, class: "profile-logout-btn" do %>
            <i class="fa-solid fa-right-from-bracket"></i> Log out
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Stats Section -->
  <div class="profile-stats">
    <div class="stat-item">
      <span class="stat-number"><%= @places_count %></span>
      <span class="stat-label">Saved</span>
    </div>
    <div class="stat-item">
      <span class="stat-number"><%= @comments.count %></span>
      <span class="stat-label">Reviews</span>
    </div>
    <div class="stat-item">
      <span class="stat-number"><%= @comments.joins(:photos_attachments).distinct.count %></span>
      <span class="stat-label">Photos</span>
    </div>
  </div>


  <!-- Travel Book Section -->
  <% if @travel_book && @travel_book.places.any? %>
    <div class="profile-section">
      <div class="section-header">
        <h2><i class="fa-solid fa-book"></i> Travel Book</h2>
        <% if @user == current_user %>
          <%= link_to "View All", my_travel_book_path, class: "section-link" %>
        <% end %>
      </div>
      <div class="travel-book-slider">
        <% @travel_book.places.limit(10).each do |place| %>
          <%= link_to city_place_path(place.city, place), class: "travel-book-card" do %>
            <% photo = place.comments.flat_map { |c| c.photos.to_a }.first %>
            <% if photo %>
              <div class="card-image" style="background-image: url('<%= cl_image_path photo.key, height: 300, width: 400, crop: :fill %>');"></div>
            <% elsif place.default_img_url.present? %>
              <div class="card-image" style="background-image: url('<%= place.default_img_url %>');"></div>
            <% else %>
              <div class="card-image card-image-placeholder">
                <i class="fa-solid fa-map-pin"></i>
              </div>
            <% end %>
            <div class="card-overlay"></div>
            <div class="card-info">
              <h3 class="card-title"><%= truncate(place.title, length: 25) %></h3>
              <p class="card-location"><i class="fa-solid fa-location-dot"></i> <%= place.city.name %></p>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Recent Reviews Section -->
  <div class="profile-section">
    <div class="section-header">
      <h2><i class="fa-solid fa-comment"></i> Recent Reviews</h2>
    </div>
    <% if @comments.any? %>
      <div class="reviews-list" data-controller="load-more" data-load-more-items-per-page-value="3">
        <% @comments.each_with_index do |comment, index| %>
          <div class="review-card" data-load-more-target="item" <%= 'style=display:none;' if index >= 3 %>>
            <div class="review-header">
              <%= link_to city_place_path(comment.place.city, comment.place), class: "review-place-link" do %>
                <i class="fa-solid fa-location-dot"></i>
                <%= comment.place.title %>
              <% end %>
              <span class="review-date"><%= time_ago_in_words(comment.created_at) %> ago</span>
            </div>
            <p class="review-text"><%= truncate(comment.description, length: 200) %></p>
            <% if comment.photos.any? %>
              <div class="review-photos">
                <% comment.photos.limit(4).each do |photo| %>
                  <%= cl_image_tag photo.key, height: 80, width: 80, crop: :fill, class: "review-photo" %>
                <% end %>
                <% if comment.photos.count > 4 %>
                  <span class="more-photos">+<%= comment.photos.count - 4 %></span>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
        <% if @comments.count > 3 %>
          <button class="load-more-btn" data-load-more-target="button" data-action="click->load-more#loadMore">
            Load more <i class="fa-solid fa-chevron-down"></i>
          </button>
        <% end %>
      </div>
    <% else %>
      <div class="empty-state">
        <i class="fa-regular fa-comment-dots"></i>
        <p>No reviews yet</p>
        <% if @user == current_user %>
          <%= link_to "Write your first review", new_comment_path, class: "empty-state-btn" %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

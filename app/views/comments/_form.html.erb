<div class="comment-form-wrapper">
  <div class="comment-form-card">
    <%= simple_form_for comment, local: true, url: comments_path, html: { class: "styled-comment-form" } do |f| %>
      <% # Show place selection if from_camera but no specific place selected yet %>
      <% if params[:from_camera] && !params[:place_id] && !params[:new_place] %>
        <!-- Camera Flow: Select Existing Place or Create New -->
        <div class="form-section" data-controller="place-selector">
          <h3 class="form-section-title">
            <i class="fa-solid fa-location-dot"></i>
            Select a Place
          </h3>

          <div class="form-field">
            <label class="styled-label">Where did you take this photo?</label>
            <select class="styled-select" data-action="change->place-selector#handleChange">
              <option value="">Choose a place...</option>
              <% if @nearby_places.present? %>
                <optgroup label="Nearby Places (within 10km)">
                  <% @nearby_places.each do |p| %>
                    <option value="<%= new_comment_path(place_id: p.id, from_camera: true) %>">
                      <%= p.title %>
                    </option>
                  <% end %>
                </optgroup>
              <% end %>
              <option value="new_place">+ Add a New Place</option>
            </select>
          </div>
        </div>

        <div class="form-divider"></div>
      <% elsif local_assigns[:place]&.new_record? %>
        <!-- Comment Flow: Create New Place -->
        <div class="form-section">
          <h3 class="form-section-title">
            <i class="fa-solid fa-location-dot"></i>
            Add a New Place
          </h3>

          <%= simple_fields_for :place, place do |p| %>
            <div
              data-controller="place-name-autocomplete address-autocomplete"
              data-place-name-autocomplete-lat-value="<%= place.latitude %>"
              data-place-name-autocomplete-lng-value="<%= place.longitude %>"
              data-place-name-autocomplete-mapbox-token-value="<%= ENV['MAPBOX_API_KEY'] %>"
              data-address-autocomplete-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>">
              <div class="form-field">
                <%= p.input :title,
                  label: "Place Name",
                  placeholder: "e.g. Sagrada Familia",
                  input_html: {
                    class: "styled-input",
                    data: {
                      place_name_autocomplete_target: "input",
                      action: "input->place-name-autocomplete#search keydown->place-name-autocomplete#handleKeydown"
                    }
                  } %>
                <% if params[:from_camera] && place.title.present? %>
                  <p class="form-hint">
                    <i class="fa-solid fa-circle-info"></i> Auto-detected from your location
                  </p>
                <% end %>
              </div>

              <div class="form-field">
                <%= p.input :city_id,
                  collection: City.order(:name),
                  label: "City",
                  prompt: "Select a city first",
                  input_html: {
                    class: "styled-select",
                    data: { address_autocomplete_target: "citySelect", action: "change->address-autocomplete#cityChanged" }
                  } %>
                <% if params[:from_camera] && place.city.present? %>
                  <p class="form-hint">
                    <i class="fa-solid fa-circle-info"></i> Auto-selected from your location: <strong><%= place.city.name %></strong>
                  </p>
                <% end %>
              </div>

              <div class="form-field">
                <%= p.input :address,
                  label: "Address",
                  placeholder: "Enter the address",
                  input_html: {
                    class: "styled-input",
                    data: { address_autocomplete_target: "address", place_name_autocomplete_target: "address" }
                  } %>
                <% if params[:from_camera] && place.address.present? %>
                  <p class="form-hint">
                    <i class="fa-solid fa-circle-info"></i> Auto-detected from your location
                  </p>
                <% end %>
                <%= p.input :latitude, as: :hidden, input_html: { data: { address_autocomplete_target: "latitude", place_name_autocomplete_target: "latitude" } } %>
                <%= p.input :longitude, as: :hidden, input_html: { data: { address_autocomplete_target: "longitude", place_name_autocomplete_target: "longitude" } } %>
              </div>
            </div>
          <% end %>
        </div>

        <div class="form-divider"></div>
      <% end %>

      <div class="form-section">
        <h3 class="form-section-title">
          <i class="fa-solid fa-pen-to-square"></i>
          Your Experience
        </h3>

        <div class="form-field">
          <%= f.input :description,
            as: :text,
            label: "Share your experience",
            placeholder: "Tell others about your visit... What made it special? Any tips for future visitors?",
            input_html: { class: "styled-textarea", rows: 5 } %>
          <p class="form-hint">Minimum 20 characters</p>
        </div>

        <% # Show camera photo preview if from camera flow %>
        <% if params[:from_camera] && session[:captured_blob_id].present? %>
          <div class="form-field">
            <label class="styled-label">
              <i class="fa-solid fa-image"></i> Photo from Camera
            </label>
            <div class="camera-photo-preview-section">
              <%= image_tag url_for(ActiveStorage::Blob.find_signed(session[:captured_blob_id])),
                            class: "camera-photo-preview-img" %>
            </div>
            <p class="form-hint">
              <i class="fa-solid fa-check-circle"></i> Your camera photo will be added to this place
            </p>
          </div>
        <% end %>
      </div>

      <!-- Hidden field to pass place_id if present -->
      <% if params[:place_id].present? %>
        <%= hidden_field_tag :place_id, params[:place_id] %>
      <% end %>

      <div class="form-actions">
        <% button_text = if local_assigns[:place]&.new_record?
          "Add Place"
        elsif params[:from_camera]
          "Add Photos to Place"
        else
          "Add Comment"
        end %>
        <%= f.submit button_text, class: "btn-submit-form" %>
      </div>
    <% end %>
  </div>
</div>
